<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>musicgrid.io game of royalty</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-image: url('bgimg.png');
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        .header {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .title {
            font-size: 2.5em;
            margin: 0;
        }

        .subheader {
            font-size: 1.2em;
            margin-top: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .row {
            display: flex;
            width: 100%;
            position: relative;
        }

        .cell {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.1em;
            min-height: 50px;
            background-color: #e3f2fd;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
        }

        .genre-header, .artist {
            background-color: #bbdefb;
        }

        .invisible {
            visibility: hidden;
        }

        .results-dropdown {
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: absolute;
            width: 100%;
            z-index: 1000;
        }

        .results-dropdown div:hover {
            background-color: #f0f0f0;
        }

        .results-dropdown {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: absolute;
            width: calc(100% - 20px); /* adjust width as needed */
            z-index: 1000;
            top: 100%; /* make sure it starts right after the input field */
            left: 0; /* align to the left edge of the input field */
            margin-top: 5px; /* add a little space below the input field */
        }

        .results-dropdown div {
            padding: 10px; /* add more padding for spacing between results */
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0; /* add a subtle line between each result */
        }

        .results-dropdown div:last-child {
            border-bottom: none; /* no border for the last item */
        }

        /* Style for the song title to be bold */
        .song-title {
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        
        @media (max-width: 600px) {
            .cell, .genre-header, .artist {
                font-size: 14px;
                padding: 8px 5px;
            }
        
            .results-dropdown {
                width: 100%;
                box-sizing: border-box;
                top: 100%;
            }
        
            .results-dropdown div {
                padding: 5px;
            }
        
            .song-cell {
                position: relative;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">musicgrid.io</div>
        <div class="subheader">Guess the song that matches each artist and category</div>
        <div class="subheader">now andrew can roast <i>everyone's</i> music taste</div>
    </div>
    <div class="header">
        <div class="subheader"><i>no guarantees on accuracy, ChatGPT made this grid</i></div>
        <div class="subheader"><i>get more points when you guess less popular song answers</i></div>
        <div class="subheader"><i>Guesses remaining:<span id="guessesRemaining"> 10</span> out of 10</i></div>
   
    </div>

    <div class="container">
    <!-- Artists Row -->
        <div class="row">
            <div class="cell invisible"></div>
            <div class="cell artist">Michael Jackson</div>
            <div class="cell artist">Madonna</div>
            <div class="cell artist">U2</div>
        </div>
    
    <!-- Category 1: Songs That Won Grammy Awards -->
        <div class="row">
            <div class="cell genre-header">Songs That Won Grammy Awards</div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Beat It', 'Billie Jean', 'Thriller', 'Black or White', 'Don\'t Stop \'Til You Get Enough', 'Heal the World', 'Leave Me Alone', 'Scream', 'They Don\'t Care About Us', 'Stranger in Moscow'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Ray of Light', 'Beautiful Stranger', 'Vogue', 'Who\'s That Girl', 'Open Your Heart', 'Express Yourself', 'Papa Don\'t Preach', 'Like a Prayer'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['With or Without You', 'I Still Haven\'t Found What I\'m Looking For', 'Where the Streets Have No Name', 'Desire', 'The Fly', 'Mysterious Ways', 'Beautiful Day', 'Stuck in a Moment You Can\'t Get Out Of', 'Walk On', 'Elevation', 'Vertigo', 'Sometimes You Can\'t Make It on Your Own', 'City of Blinding Lights'])" placeholder="Type to search...">
            </div>
        </div>
    
    
        <!-- Category 2: Songs Released in the 1980s -->
        <div class="row">
            <div class="cell genre-header">Songs Released in the 1980s</div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Don\'t Stop \'Til You Get Enough', 'Rock with You', 'Billie Jean', 'Beat It', 'Wanna Be Startin\' Somethin\'', 'Human Nature', 'P.Y.T. (Pretty Young Thing)', 'Thriller', 'Bad', 'The Way You Make Me Feel', 'Man in the Mirror', 'Dirty Diana', 'Smooth Criminal', 'Another Part of Me', 'Leave Me Alone', 'Liberian Girl'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Like a Virgin', 'Material Girl', 'Angel', 'Into the Groove', 'Dress You Up', 'Live to Tell', 'Papa Don\'t Preach', 'True Blue', 'Open Your Heart', 'La Isla Bonita', 'Like a Prayer', 'Express Yourself', 'Cherish', 'Oh Father', 'Keep It Together'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['I Will Follow', 'Twilight', 'An Cat Dubh', 'Into the Heart', 'Out of Control', 'Stories for Boys', 'The Ocean', 'A Day Without Me', 'Another Time, Another Place', 'The Electric Co.', 'Shadows and Tall Trees'])" placeholder="Type to search...">
            </div>
        </div>
    
    
        <!-- Category 3: Songs From Debut Albums -->
        <div class="row">
            <div class="cell genre-header">Songs From Debut Albums</div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Don\'t Stop \'Til You Get Enough', 'Rock with You', 'Working Day and Night', 'Get on the Floor', 'Off the Wall', 'Girlfriend', 'She\'s Out of My Life', 'I Can\'t Help It', 'It\'s the Falling in Love', 'Burn This Disco Out'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['Lucky Star', 'Borderline', 'Burning Up', 'I Know It', 'Holiday', 'Think of Me', 'Physical Attraction', 'Everybody'])" placeholder="Type to search...">
            </div>
            <div class="cell song-cell">
                <input type="text" oninput="liveSearch(this, ['I Will Follow', 'Twilight', 'An Cat Dubh', 'Into the Heart', 'Out of Control', 'Stories for Boys', 'The Ocean', 'A Day Without Me', 'Another Time, Another Place', 'The Electric Co.', 'Shadows and Tall Trees'])" placeholder="Type to search...">
            </div>
        </div>
    </div>
    
    <!-- Placeholder for the final score -->
    <div class="header">
        <div class="subheader">
            Total Score:<span id="totalScore"> 1</span>
        </div>
    </div>
    
    <div class="header">
        <div class="subheader">
            <div id="leaderboard">
                <h2>Leaderboard</h2>
                <ul id="leaderboardList">
                    <!-- Leaderboard entries will be added here -->
                </ul>
            </div>
        </div>
    </div>
        
        
    </div>

    <script>

    
        // You get one point just for being here
        let totalScore = 1; 

        // Guesses don't last forever...
        let guessTotal = 10;

        // How good are ya really?
        let correctGuesses = 0;
        
        function liveSearch(inputElement, answers) {
            if (inputElement.value.length > 2) {
                console.log('Requesting search for '+inputElement.value);
                searchSpotify(inputElement.value)
                    .then(songs => displaySpotifyResults(songs, inputElement, answers))
                    .catch(error => console.error('Error fetching Spotify data:', error));
            } else {
                removeDropdown(inputElement);
            }
        }

        async function searchAnswers(answerTerms) {
            console.log('Initializing evaluation of answers ' + answerTerms);
            let promises = answerTerms.map(answerTerm => searchSpotify(answerTerm));
        
            // Wait for all promises to resolve
            let results = await Promise.all(promises);
            
            // Process the results to extract popularity values
            let answerPopsArr = results.map(result => {
                // Assuming the result structure includes an array of songs
                if (result.length > 0 && result[0].popularity !== undefined) {
                    return result[0].popularity; // Take the popularity of the first song as an example
                }
                return null; // Handle cases where no songs are found or structure is different
            });

            console.log('Answer Pops Array now at: ', answerPopsArr.toString());
            return answerPopsArr;
        }
        
        async function searchSpotify(searchTerm) {
            console.log('Searching for '+searchTerm)
            const response = await fetch('https://music-grid-io-42616e204fd3.herokuapp.com/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ searchTerm })
            });
            console.log('Received response: '+response)
            if (!response.ok) throw new Error('Failed to fetch');
            return response.json();
        }
        function displaySpotifyResults(songs, inputElement, answers) {
            removeDropdown(inputElement); // Remove existing dropdown if present
            console.log('Creating results container');
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-dropdown';
            resultsContainer.style.top = '100%'; 
            resultsContainer.style.left = '0';
            console.log('Populating results container')
            songs.forEach(song => {
                const songElement = document.createElement('div');
                const songTitleSpan = document.createElement('span');
                console.log('Populating '+song.name)
                songTitleSpan.className = 'song-title'; // Apply bold styling to the song title
                songTitleSpan.textContent = song.name;
                songElement.appendChild(songTitleSpan);
                songElement.innerHTML += ` by ${song.artists.map(artist => artist.name).join(', ')}`; // Add artist name(s)
                resultsContainer.appendChild(songElement);
                songElement.onclick = () => {
                    console.log('Selected song '+`${song.name} by ${song.artists.map(artist => artist.name).join(', ')}`)
                    selectSong(`${song.name} by ${song.artists.map(artist => artist.name).join(', ')}`, inputElement, answers, song.popularity);
                    // Clear the dropdown after selection
                    resultsContainer.innerHTML = '';
                    resultsContainer.appendChild(songElement);
                };
            });
        
            // Position the results dropdown so it doesn't cover the input field
            inputElement.parentNode.style.position = 'relative';
            inputElement.parentNode.appendChild(resultsContainer);
        }

        // Add a utility function for basic similarity check
        function isSimilar(guess, correctAnswers) {
            console.log('Evaluating guess: '+guess);
            console.log('By answers: '+correctAnswers);
            return correctAnswers.some(answer => guess.toLowerCase().includes(answer.toLowerCase()));
        }
        
        function selectSong(songInfo, inputElement, answers, popularity) {
            // Decrease guess total for making a guess
            let newGuessTotal = guessTotal - 1;
            console.log('Decrementing guess total from '+guessTotal+' to '+newGuessTotal);
            guessTotal = newGuessTotal;

            // Check if guess is correct
            console.log('Checking guess '+songInfo);
            const cell = inputElement.closest('.cell');
            const isCorrect = isSimilar(songInfo, answers);

            // Mark cell as correct if right, otherwise highlight red
            if (isCorrect) {
                cell.style.backgroundColor = '#c8e6c9'; // Green for correct
                cell.textContent = 'Correct: ' + songInfo + '(pop: '+popularity+')';
                correctGuesses+=1;
                inputElement.disabled = true;
                updateScoreForGuess(popularity,answers);
            } else {
                cell.style.backgroundColor = '#ffcdd2'; // Red for incorrect
                // cell.textContent = 'Incorrect! Possible answers: ' + answers.join(', ');
            }

            removeDropdown(inputElement);
            console.log('Requesting scoring for guess: '+songInfo);
            
            // Handle new guess total
            if (guessTotal == 0) {
                terminateGame();
            } else {
                decrementGuesses();
            }
        }

        function decrementGuesses() {
            guessesReadable = ' '+guessTotal
            document.getElementById("guessesRemaining").textContent=guessesReadable;
        }
        
        function terminateGame() {
            const songCells = document.querySelectorAll('.song-cell');
            songCells.forEach(cell => {
                const inputField = cell.querySelector('input[type="text"]');
                if (inputField) {
                    if (!inputField.disabled) {
                        // Extract correct answers from the oninput attribute
                        const correctAnswers = extractCorrectAnswers(inputField.getAttribute('oninput'));
        
                        // Update the cell to show it's incorrect and display correct answers
                        cell.style.backgroundColor = '#ffcdd2'; // Red for incorrect
                        const correctAnswerText = document.createElement('div');
                        correctAnswerText.innerHTML = 'Incorrect! Correct answers: <br>' + correctAnswers.join(', ');
                        cell.appendChild(correctAnswerText);
                        inputField.disabled = true;
                    }
                } else {
                    console.error('Input field not found in the cell:', cell);
                }
            });
        
            // Provide feedback that the game has ended
            displayEndGameMessage();
            let playerName = prompt("Enter your name for the leaderboard:");
            if (playerName) {
                leaderboardUpdate(playerName, totalScore);
            }
        }
        
        function extractCorrectAnswers(oninputValue) {
            // Assuming the format is liveSearch(this, ['Answer1', 'Answer2', ...])
            const answersMatch = oninputValue.match(/\[\s*'(.*?)'\s*\]/);
            return answersMatch ? answersMatch[1].split("', '") : [];
        }
        
        function displayEndGameMessage() {
            const endGameMessage = document.createElement('div');
            endGameMessage.innerHTML = "<strong>Game Over!</strong> Here are the songs you missed.";
            document.querySelector('.container').prepend(endGameMessage);
        }

        function loadLeaderboard() {
            fetch('https://music-grid-io-42616e204fd3.herokuapp.com/scores')
                .then(response => response.json())
                .then(scores => {
                    console.log('Selecting leaderboard div');
                    const leaderboardList = document.getElementById("leaderboardList");
                    leaderboardList.innerHTML = ''; // Clear existing list
                    scores.forEach(({ rank, player_name, player_score }) => {
                        console.log('Creating leaderboard entry: '+rank+': '+player_name+' ('+player_score+')');
                        const entry = document.createElement("li");
                        entry.textContent = `#${rank}: ${player_name} (${player_score})`;
                        console.log('Appending entry');
                        leaderboardList.appendChild(entry);
                    });
                    console.log('Done appending');
                })
                .catch(error => console.error('Error:', error));
        }
        
        // Call this function when the page loads to display the leaderboard
        window.onload = function() {
            loadLeaderboard();
        };
            
        // Add submitted game + username to leaderboard, let's not worry about sanitizing for now as there's not much to hack
        function leaderboardUpdate(playerName, score) {
            fetch('https://music-grid-io-42616e204fd3.herokuapp.com/submit-score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: playerName, score: score })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                loadLeaderboard(); // Refresh the leaderboard after updating
            })
            .catch(error => console.error('Error:', error));
        }

        // TODO: Display leaderboard from CSV on first pageload
            // Add give up button
            
        function removeDropdown(inputElement) {
            if (inputElement && inputElement.parentNode) {
                const existingContainer = inputElement.parentNode.querySelector('.results-dropdown');
                if (existingContainer) {
                    inputElement.parentNode.removeChild(existingContainer);
                }
            } else {
                console.error('Input element is not in the DOM or has no parent.');
            }
        }

        
        // Function to update the score based on the user's guess
        async function updateScoreForGuess(popularity, answers) {
            calculateAnswerPops(answers);
            var cellScoreMax = 0;
            var cellScoreMin = 0;
            var normedGuessScore = 0;
            var popInt = parseInt(popularity);
            console.log('Norming score off popularity of '+popInt+' from string '+popularity);
            let answerPops = await calculateAnswerPops(answers);
            console.log('Popularities returned to score updater for: '+answers.toString());
            console.log('Returned popularities: '+answerPops.toString());
            cellScoreMax = Math.max.apply(Math, answerPops);
            console.log('Max cell popularity determined as: '+cellScoreMax);
            cellScoreMin = Math.min.apply(Math, answerPops);
            console.log('Min cell popularity determined as: '+cellScoreMin);
            if (cellScoreMin == cellScoreMax) {
                normedGuessScore = 9;
            } else {
                normedGuessScore = 6+5*Math.round(10*(1 - ((popInt - cellScoreMin)/(cellScoreMax - cellScoreMin))))/10;
            }
            
            console.log('Normed score determined as: '+normedGuessScore);
            console.log('Adding normed score to prior total of '+totalScore);
            totalScore+=normedGuessScore;
            console.log('Displaying new total score of '+normedGuessScore);
            updateScoreTo(totalScore);
        }

        async function calculateAnswerPops(answers) {
            console.log('Parsing answer popularities');
            let answerPops = await searchAnswers(answers);
            console.log('Returned popularities: ', answerPops.toString());
        
            // Filter out null values if any song wasn't found or popularity was missing
            answerPops = answerPops.filter(pop => pop !== null);
        
            console.log('Filtered answer popularities: ', answerPops.toString());
            return answerPops;
        }
        
        function updateScoreTo(totalScore) {
            scoreReadable = ' '+totalScore
            document.getElementById("totalScore").textContent=scoreReadable;
        }
        
    </script>
</body>
</html>
